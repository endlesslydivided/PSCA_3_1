<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>4 Lab</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    <style>
        body,html {
          height: 100%;
          padding: 1%;
        }
        input[type="number"],input[type="text"],input[type="date"],select.form-control 
        {
        background: transparent;
        border: none;
        border-bottom: 2px solid #555555;
        -webkit-box-shadow: none;
        box-shadow: none;
        border-radius: 0;
        }
        input[type="text"]:focus,select.form-control:focus 
        {
        -webkit-box-shadow: none;
        box-shadow: none;
        }

        </style>
</head>
<body>
    <section id="insert-names">
        <div class="container align-items-center h-100 w-50">
            <div class="row  h-100">
                <div class="container ">
                    <div class="row align-items-start">
                        <div class="mb-3 col ">
                            <label for="id" class="form-label">ID:</label>
                            <input name="newnamesData" id="id" type="number">
                        </div>
                    </div>
                    <div class="row align-items-start">
                        <div class="mb-3 col ">
                            <label for="name" class="form-label">Имя:</label>
                            <input name="newnamesData" id="name" type="text">
                        </div>
                    </div>
                    <div class="row align-items-start">
                        <div class="mb-3 col ">
                            <label for="birth" class="form-label">День рождения:</label>
                            <input name="newnamesData" id="birth" type="date">
                           
                    </div>   
                    <div class="row align-items-start">   
                        <div class="mb-4 col"> 
                            <button class="btn btn-primary" onclick="Get()">Get</button>
                            <button class="btn btn-primary" onclick="Post()">POST/PUT</button>
                            <button class="btn btn-primary" onclick="Comm()">Commit</button> 
                        </div> 
                    </div>   
                    <section id="select-names" style="border: 1px solid black "></section>                      
                </div>
            </div>
        </div>      
    </section>

    <script>
        const ENDPOINT = 'http://localhost:5000/api/db';
        const COMMPOINT = 'http://localhost:5000/commit';
        const STATPOINT = 'http://localhost:5000/api/ss';

        function Get() {
            fetch(ENDPOINT, {method: 'GET'})
                .then(response => response.json())
                .then(jsonResponse => {
                    let container = document.getElementById('select-names');
                    container.innerHTML = '';
                    jsonResponse.forEach(names => 
                    {
                        let namesContainer = document.createElement('div');
                        let deleteButton = document.createElement('button');

                        deleteButton.setAttribute('onclick', 'Delete(event)');
                        deleteButton.setAttribute('namesId', names.id);
                        deleteButton.setAttribute('class','btn btn-danger');
                        deleteButton.innerText = 'Delete';

                        namesContainer.innerHTML = `${names.id}. ${names.name}, ${names.birth}`;
                        namesContainer.appendChild(deleteButton);

                        container.append(namesContainer, document.createElement('br'));
                    });
                });
        }

        function Getid(namesData, namesId) {
            fetch(ENDPOINT, {method: 'GET'})
                .then(response => response.json())
                .then(jsonResponse => {
                  let a = true;
                    jsonResponse.forEach(names => 
                    {
                      if((namesId == names.id))
                        {
                            a = false;
                        }
                    });
                    let container = document.getElementById('select-names');
                    container.innerHTML = '';
                    let namesContainer = document.createElement('div');
                    if(a)
                    {
                        namesContainer.innerHTML += `<span>Строка добавлена</span>`;
                    }
                    else
                    {
                        namesContainer.innerHTML += `<span>Строка обновлена</span>`;
                    }
                    
                    container.append(namesContainer, document.createElement('br'));
                    UPD_INS(namesData, namesId, a)

                });
        }

        function Post() {
            let namesData = Array.from(document.getElementsByName('newnamesData')).map(a => 
            {
                return {field: a.getAttribute('id'), value: a.value};
            });
            let namesId = namesData.find(a => a.field === 'id').value;
            let container = document.getElementById('select-names');
            container.innerHTML = '';
            let namesContainer = document.createElement('div');
            namesContainer.innerHTML = `<span>${namesData.find(a => a.field === 'id').value}. ${namesData.find(a => a.field === 'name').value}, ${namesData.find(a => a.field === 'birth').value}</span>`;
            container.append(namesContainer, document.createElement('br'));
            Getid(namesData, namesId);
        }

        function UPD_INS(namesData, namesId, a) {
            fetch(ENDPOINT, {
                method: a ? 'POST' : 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    id: Number(namesId),
                    name: namesData.find(a => a.field === 'name').value,
                    birth: namesData.find(a => a.field === 'birth').value,
                })
            })
        }

        function Delete(event) {
            fetch(ENDPOINT + '?id=' + event.target.getAttribute('namesId'),{method: 'DELETE'}).then(
                response => response.json()).then(jsonResponse =>
            {
                let container = document.getElementById('select-names');
                container.innerHTML = '';
                let namesContainer = document.createElement('div');
                namesContainer.innerHTML = `Удалённая строка:  <p>${jsonResponse.id}. ${jsonResponse.name} ,  ${jsonResponse.birth}</p>`;
                container.append(namesContainer, document.createElement('br'));
            });

        }

        function Comm()
        {
          fetch(COMMPOINT, {method: 'Get'})
              .then(response => {
                  let container = document.getElementById('select-names');
                  container.innerHTML = '';
                  let namesContainer = document.createElement('div');
                  namesContainer.innerHTML = `<span>COMMITED</span>`;
                  container.append(namesContainer, document.createElement('br'));

              });
        }
    </script>
</body>
</html>
